"use strict";(self.webpackChunkmiuform=self.webpackChunkmiuform||[]).push([[472],{472:(q,y,n)=>{n.r(y),n.d(y,{ReportsModule:()=>I});var f=n(6895),u=n(9132),a=n(4006),w=n(7188),h=n(590),g=n(4004),C=n(5577),t=n(4650),J=n(1481),A=n(577),_=n(4859),b=n(7392),E=n(4144),F=n(9549),O=n(4385),P=n(3238),U=n(4463);function M(s,o){if(1&s&&(t.TgZ(0,"mat-option",13),t._uU(1),t.qZA()),2&s){const e=o.$implicit;t.Q6J("value",e._id),t.xp6(1),t.AsE("",e.shortName,"-",e.name,"")}}function k(s,o){if(1&s&&(t.TgZ(0,"div",14)(1,"div",15),t._UZ(2,"img",16),t.qZA()()),2&s){const e=o.$implicit,i=o.index,r=t.oxw(2);t.xp6(1),t.Q6J("formGroupName",i),t.xp6(1),t.Q6J("src",r.blobToSrc(e.get("blob").value),t.LSH)}}function Y(s,o){if(1&s){const e=t.EpF();t.TgZ(0,"div")(1,"p"),t._uU(2),t.qZA(),t.TgZ(3,"form",1)(4,"mat-form-field")(5,"mat-label"),t._uU(6),t.ALo(7,"translate"),t.qZA(),t._UZ(8,"input",2),t.ALo(9,"translate"),t.qZA(),t.TgZ(10,"mat-form-field")(11,"mat-select",3),t.ALo(12,"translate"),t.YNc(13,M,2,3,"mat-option",4),t.qZA()(),t.TgZ(14,"div",5)(15,"button",6),t.NdJ("click",function(){t.CHM(e);const r=t.MAs(19);return t.KtG(r.click())}),t.TgZ(16,"mat-icon"),t._uU(17,"library_add"),t.qZA(),t.TgZ(18,"input",7,8),t.NdJ("change",function(r){t.CHM(e);const c=t.oxw();return t.KtG(c.onFileInput(r))}),t.qZA()(),t.TgZ(20,"button",6),t.NdJ("click",function(){t.CHM(e);const r=t.MAs(19);return t.KtG(r.click())}),t.TgZ(21,"mat-icon"),t._uU(22,"delete"),t.qZA()(),t.TgZ(23,"button",6),t.NdJ("click",function(){t.CHM(e);const r=t.MAs(19);return t.KtG(r.click())}),t.TgZ(24,"mat-icon"),t._uU(25,"done_all"),t.qZA()(),t.TgZ(26,"button",6),t.NdJ("click",function(){t.CHM(e);const r=t.MAs(19);return t.KtG(r.click())}),t.TgZ(27,"mat-icon"),t._uU(28,"remove_done"),t.qZA()()(),t.TgZ(29,"div",9),t.YNc(30,k,3,2,"div",10),t.qZA()(),t.TgZ(31,"button",11),t.NdJ("click",function(){t.CHM(e);const r=t.oxw();return t.KtG(r.saveReport())}),t.TgZ(32,"mat-icon"),t._uU(33,"save"),t.qZA()(),t.TgZ(34,"button",12),t.NdJ("click",function(){t.CHM(e);const r=t.oxw();return t.KtG(r.preview())}),t.TgZ(35,"mat-icon"),t._uU(36,"rebase_edit"),t.qZA()()()}if(2&s){const e=t.oxw();t.xp6(2),t.Oqu(e.item._id),t.xp6(1),t.Q6J("formGroup",e.itemForm),t.xp6(3),t.Oqu(t.lcZ(7,7,"ITEM.REPORT.PRODUCT_ID")),t.xp6(2),t.s9C("placeholder",t.lcZ(9,9,"ITEM.REPORT.PRODUCT_ID")),t.xp6(3),t.s9C("placeholder",t.lcZ(12,11,"ITEM.REPORT.FACTORY")),t.xp6(2),t.Q6J("ngForOf",e.factoryItems),t.xp6(17),t.Q6J("ngForOf",null==e.images?null:e.images.controls)}}function L(s,o){1&s&&(t.TgZ(0,"div")(1,"p"),t._uU(2,"Raport nie istnieje."),t.qZA()())}class v{constructor(o,e,i,r,c,l){this.formBuilder=o,this.domSanitizer=e,this.logger=i,this.router=r,this.activatedRoute=c,this.reportService=l,this.item=void 0,this.factoryItems=[],this.onFileInput=p=>{console.log("aaa"),p.target.files&&p.target.files.length>0&&(0,w.$)(Array.from(p.target.files).map(m=>this.resizeImage(m,1200,1200))).subscribe({next:m=>{console.log(m),m.forEach(d=>this.images.push(new a.cw({blob:new a.NI(d.blob),size:new a.NI(d.size)}))),console.log(this.images)},error:m=>{console.error(m)}})}}ngOnInit(){this.activatedRoute.params.pipe((0,h.P)(),(0,g.U)(o=>o.id),(0,C.z)(o=>(this.logger.debug(`prepare report for id: ${o}`),void 0!==o&&""!==o?this.reportService.getReport(o):this.reportService.createNewReport())),(0,h.P)(),(0,C.z)(o=>(this.item=o,this.itemForm=this.formBuilder.group({_id:[this.item._id],_rev:[this.item._rev],dateOfCreation:[this.item.dateOfCreation],productId:[this.item.productId,[a.kI.required,a.kI.minLength(3)]],factoryInfoId:[this.item.factoryInfoId,[a.kI.required]],checklist:this.formBuilder.array(this.item.checklist.map(e=>this.formBuilder.group({checklistItemId:[e.checklistItemId],comment:[e.comment],pointImages:this.formBuilder.array(e.pointImages.map(i=>this.formBuilder.group({...i}))),content:[e.content],isChecked:[e.isChecked]}))),images:this.formBuilder.array(this.item.images.map(e=>this.formBuilder.group({...e}))),reportPath:[this.item.reportPath],dateOfGenerating:[this.item.dateOfGenerating],dateOfDelivery:[this.item.dateOfDelivery]}),this.reportService.getFactories(!1))),(0,h.P)(),(0,g.U)(o=>this.factoryItems=o)).subscribe()}getFromFormGroup(){return this.itemForm.getRawValue()}preview(){let o=this.getFromFormGroup();this.reportService.updateReport(o).pipe((0,h.P)()).subscribe({next:e=>{this.router.navigate(["/reports/preview",o._id])},error:e=>console.error(e)})}saveReport(){let o=this.getFromFormGroup();this.reportService.updateReport(o).pipe((0,h.P)(),(0,g.U)(e=>e)).subscribe()}get images(){return this.itemForm.get("images")}blobToSrc(o){return console.log("blobToSrc: "+o),this.domSanitizer.bypassSecurityTrustUrl(URL.createObjectURL(o))}getScale(o,e,i){if(o.width<=e&&o.height<=i)return{width:o.width,height:o.height};let r,c;return o.width>o.height?(c=o.height*(e/o.width),r=e):(r=o.width*(i/o.height),c=i),{width:r,height:c}}resizeImage(o,e,i){return new Promise((r,c)=>{let l=new Image;l.src=URL.createObjectURL(o),l.onload=()=>{let d,T,p=l.width,m=l.height;p<=e&&m<=i&&r({blob:o,size:{width:p,height:m}}),p>m?(T=m*(e/p),d=e):(d=p*(i/m),T=i);let R=document.createElement("canvas");R.width=d,R.height=T,R.getContext("2d").drawImage(l,0,0,d,T),R.toBlob(j=>{r({blob:j,size:{width:d,height:T}})},o.type)},l.onerror=c})}static#t=this.\u0275fac=function(e){return new(e||v)(t.Y36(a.qu),t.Y36(J.H7),t.Y36(A.Yd),t.Y36(u.F0),t.Y36(u.gz),t.Y36(A.rM))};static#e=this.\u0275cmp=t.Xpm({type:v,selectors:[["app-prepare-report"]],decls:5,vars:5,consts:[[4,"ngIf"],[1,"an-flex","an-flex-direction-column",3,"formGroup"],["matInput","","formControlName","productId",3,"placeholder"],["formControlName","factoryInfoId",3,"placeholder"],[3,"value",4,"ngFor","ngForOf"],[2,"display","flex","flex-direction","row"],["mat-fab","",3,"click"],["type","file","accept","image/x-png,image/jpeg,image/gif","multiple","multiple",2,"display","none",3,"change"],["fileInput",""],[2,"display","flex","flex-direction","row","flex-flow","wrap"],["style","margin: 3px; border: 1px solid black","formArrayName","images",4,"ngFor","ngForOf"],["mat-fab","","color","primary",1,"mat-fab-bottom-right-second",3,"click"],["mat-fab","","color","primary",1,"mat-fab-bottom-right",3,"click"],[3,"value"],["formArrayName","images",2,"margin","3px","border","1px solid black"],[2,"width","200px","height","200px","display","flex","justify-content","center",3,"formGroupName"],[2,"display","block","max-width","200px","max-height","200px","width","auto","height","auto","margin","auto",3,"src"]],template:function(e,i){1&e&&(t.TgZ(0,"h1"),t._uU(1),t.ALo(2,"translate"),t.qZA(),t.YNc(3,Y,37,13,"div",0),t.YNc(4,L,3,0,"div",0)),2&e&&(t.xp6(1),t.Oqu(t.lcZ(2,3,"PREPARE_REPORT.TITLE")),t.xp6(2),t.Q6J("ngIf",i.item),t.xp6(1),t.Q6J("ngIf",!i.item))},dependencies:[f.sg,f.O5,_.cs,b.Hw,E.Nt,F.KE,F.hX,O.gD,P.ey,a._Y,a.Fj,a.JJ,a.JL,a.sg,a.u,a.x0,a.CE,U.X$]})}var N=n(8505),G=n(6709),S=n(4633);function B(s,o){if(1&s&&(t.TgZ(0,"mat-option",5),t._uU(1),t.qZA()),2&s){const e=o.$implicit;t.Q6J("value",e._id),t.xp6(1),t.AsE("",e.shortName,"-",e.name,"")}}function H(s,o){if(1&s){const e=t.EpF();t.TgZ(0,"div",6),t.NdJ("click",function(r){const l=t.CHM(e).$implicit,p=t.oxw();return t.KtG(p.preview(r,l._id))}),t.TgZ(1,"div",7)(2,"span"),t._uU(3),t.qZA(),t.TgZ(4,"span"),t._uU(5),t.qZA(),t.TgZ(6,"span"),t._uU(7),t.ALo(8,"date"),t.qZA()(),t.TgZ(9,"button",8),t.NdJ("click",function(r){const l=t.CHM(e).$implicit,p=t.oxw();return t.KtG(p.prepare(r,l._id))}),t.TgZ(10,"mat-icon"),t._uU(11,"edit"),t.qZA()()()}if(2&s){const e=o.$implicit,i=t.oxw();let r;t.xp6(3),t.Oqu(e.productId),t.xp6(2),t.AsE("",null==(r=i.selectFactoryInfoConfig(e.factoryInfoId))?null:r.shortName,"-",null==(r=i.selectFactoryInfoConfig(e.factoryInfoId))?null:r.name,""),t.xp6(2),t.Oqu(t.xi3(8,4,e.dateOfCreation,"YYYY-MM-d, H:mm:ss"))}}const Q=function(){return["prepare"]};class Z{constructor(o,e){this.reportService=o,this.router=e,this.loadFactoryWithNoActive=!1,this.factoryItems=[],this.items=[]}ngOnInit(){this.reloadFactories(!1).pipe((0,C.z)(o=>this.reloadReports()),(0,h.P)()).subscribe()}selectFactoryInfoConfig(o){return this.factoryItems.find(e=>e._id===o)}reloadReports(){return this.reportService.getReports(!0).pipe((0,N.b)(o=>this.items=o),(0,g.U)(o=>!0))}reloadFactories(o){return this.reportService.getFactories(o).pipe((0,N.b)(e=>this.factoryItems=e),(0,g.U)(e=>!0))}preview(o,e){this.router.navigate(["/reports/preview",e])}prepare(o,e){o.stopPropagation(),this.router.navigate(["/reports/prepare",e])}static#t=this.\u0275fac=function(e){return new(e||Z)(t.Y36(A.rM),t.Y36(u.F0))};static#e=this.\u0275cmp=t.Xpm({type:Z,selectors:[["app-reports"]],decls:16,vars:14,consts:[["multiple","",3,"placeholder"],[3,"value",4,"ngFor","ngForOf"],[3,"checked","change"],["class","an-list-item",3,"click",4,"ngFor","ngForOf"],["mat-fab","","color","primary",1,"mat-fab-bottom-right",3,"routerLink"],[3,"value"],[1,"an-list-item",3,"click"],[1,"an-list-item-des"],[3,"click"]],template:function(e,i){1&e&&(t.TgZ(0,"div")(1,"h1"),t._uU(2),t.ALo(3,"translate"),t.qZA(),t.TgZ(4,"div")(5,"mat-select",0),t.ALo(6,"translate"),t.YNc(7,B,2,3,"mat-option",1),t.qZA(),t.TgZ(8,"mat-checkbox",2),t.NdJ("change",function(c){return i.reloadFactories(c.checked)}),t._uU(9),t.ALo(10,"translate"),t.qZA()(),t.TgZ(11,"mat-list"),t.YNc(12,H,12,7,"div",3),t.qZA(),t.TgZ(13,"button",4)(14,"mat-icon"),t._uU(15,"add"),t.qZA()()()),2&e&&(t.xp6(2),t.Oqu(t.lcZ(3,7,"REPORTS.TITLE")),t.xp6(3),t.s9C("placeholder",t.lcZ(6,9,"REPORTS.FILTER_BY_FACTORIES")),t.xp6(2),t.Q6J("ngForOf",i.factoryItems),t.xp6(1),t.Q6J("checked",i.loadFactoryWithNoActive),t.xp6(1),t.hij(" ",t.lcZ(10,11,"REPORTS.LOAD_NOACTIVE_FACTORIES")," "),t.xp6(3),t.Q6J("ngForOf",i.items),t.xp6(1),t.Q6J("routerLink",t.DdM(13,Q)))},dependencies:[f.sg,u.rH,_.cs,G.oG,b.Hw,S.i$,O.gD,P.ey,f.uU,U.X$]})}const $=[{path:"",component:Z},{path:"prepare/:id",component:v},{path:"prepare",pathMatch:"full",component:v},{path:"preview",loadChildren:()=>Promise.all([n.e(592),n.e(992)]).then(n.bind(n,5992)).then(s=>s.PreviewReportModule)}];class x{static#t=this.\u0275fac=function(e){return new(e||x)};static#e=this.\u0275mod=t.oAB({type:x});static#o=this.\u0275inj=t.cJS({imports:[u.Bz.forChild($),u.Bz]})}var D=n(1608);class I{static#t=this.\u0275fac=function(e){return new(e||I)};static#e=this.\u0275mod=t.oAB({type:I});static#o=this.\u0275inj=t.cJS({imports:[f.ez,x,D.m]})}}}]);